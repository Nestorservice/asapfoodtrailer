<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testimonials Gallery | ASAP Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/admin.css">
    <style>
        .upload-zone {
            border: 2px dashed #dde1e6;
            border-radius: 16px;
            padding: 40px 24px;
            text-align: center;
            cursor: pointer;
            transition: all .3s;
            background: #fafbfc;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #ff6b00;
            background: #fff8f0;
        }

        .upload-zone i {
            font-size: 2.5rem;
            color: #ff6b00;
            margin-bottom: 12px;
        }

        .upload-zone p {
            color: #888;
            margin: 0;
            font-size: .9rem;
        }

        .upload-zone .btn-upload {
            margin-top: 12px;
            background: linear-gradient(135deg, #ff6b00, #ff8c33);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 10px 28px;
            font-weight: 600;
            cursor: pointer;
            transition: transform .2s;
        }

        .upload-zone .btn-upload:hover {
            transform: translateY(-2px);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .gallery-card {
            position: relative;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            background: #fff;
            transition: transform .3s, box-shadow .3s;
        }

        .gallery-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .gallery-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .gallery-card .card-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
        }

        .gallery-card .card-date {
            font-size: .75rem;
            color: #999;
        }

        .gallery-card .btn-delete {
            background: #fff0f0;
            color: #dc3545;
            border: none;
            border-radius: 8px;
            padding: 6px 14px;
            font-size: .78rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
        }

        .gallery-card .btn-delete:hover {
            background: #dc3545;
            color: #fff;
        }

        .upload-progress {
            display: none;
            margin-top: 16px;
        }

        .upload-progress .progress {
            height: 8px;
            border-radius: 4px;
        }

        .upload-progress .progress-bar {
            background: linear-gradient(90deg, #ff6b00, #ff8c33);
            border-radius: 4px;
            transition: width .3s;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #bbb;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            color: #ddd;
        }

        .empty-state h5 {
            font-weight: 600;
            color: #aaa;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: .85rem;
        }

        .stat-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #f0f4ff;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: .8rem;
            font-weight: 600;
            color: #0d6efd;
        }

        @media (max-width: 767px) {
            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 12px;
            }

            .gallery-card img {
                height: 140px;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="adminSidebar">
        <div class="sidebar-header">
            <img src="/assets/img/logo/logo.jpg" alt="ASAP" class="sidebar-logo" style="height:32px;border-radius:6px;">
            <button class="sidebar-close d-lg-none" onclick="toggleSidebar()"><i class="bi bi-x-lg"></i></button>
        </div>
        <nav class="sidebar-nav">
            <a href="/admin/dashboard" class="nav-item"><i class="bi bi-grid-1x2"></i> Dashboard</a>
            <a href="/admin/inventory" class="nav-item"><i class="bi bi-truck"></i> Inventory</a>
            <a href="/admin/leads" class="nav-item"><i class="bi bi-person-lines-fill"></i> Leads</a>
            <a href="/admin/testimonials" class="nav-item active"><i class="bi bi-images"></i> Testimonials</a>
            <div class="nav-divider"></div>
            <a href="/" class="nav-item"><i class="bi bi-globe"></i> View Website</a>
            <a href="/admin" class="nav-item" style="color:#ff6b6b;"><i class="bi bi-box-arrow-left"></i> Sign Out</a>
        </nav>
    </aside>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Main -->
    <main class="admin-main">
        <div class="admin-topbar">
            <div class="d-flex align-items-center gap-3">
                <button class="topbar-toggle d-lg-none" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
                <h5 class="mb-0" style="font-family:'Outfit',sans-serif;font-weight:800;">Testimonials Gallery</h5>
            </div>
            <div class="topbar-right d-flex align-items-center gap-3">
                <span class="stat-pill"><i class="bi bi-image"></i> {{ testimonials | length }} photos</span>
            </div>
        </div>

        <div class="admin-content">
            <!-- Upload Zone -->
            <div class="admin-card mb-4">
                <div class="admin-card-header">
                    <h6><i class="bi bi-cloud-arrow-up"></i> Upload Testimonial Photos</h6>
                </div>
                <div class="admin-card-body">
                    <div class="upload-zone" id="uploadZone"
                        ondragover="event.preventDefault(); this.classList.add('dragover');"
                        ondragleave="this.classList.remove('dragover');" ondrop="handleDrop(event)">
                        <i class="bi bi-cloud-arrow-up"></i>
                        <p><strong>Drag & drop images here</strong><br>or click to browse</p>
                        <button class="btn-upload" onclick="document.getElementById('fileInput').click()">
                            <i class="bi bi-plus-lg"></i> Choose Files
                        </button>
                        <input type="file" id="fileInput" accept="image/*" multiple style="display:none;"
                            onchange="handleFiles(this.files)">
                    </div>
                    <div class="upload-progress" id="uploadProgress">
                        <div class="progress">
                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted mt-1 d-block" id="progressText">Uploading...</small>
                    </div>
                </div>
            </div>

            <!-- Gallery Grid -->
            {% if testimonials %}
            <div class="gallery-grid" id="galleryGrid">
                {% for t in testimonials %}
                <div class="gallery-card" id="card-{{ t.id }}">
                    <img src="{{ t.image_url }}" alt="Testimonial" loading="lazy"
                        onerror="this.src='/assets/img/trucks/placeholder.jpg';">
                    <div class="card-actions">
                        <span class="card-date">
                            <i class="bi bi-calendar3"></i>
                            {{ t.created_at[:10] if t.created_at else 'Unknown' }}
                        </span>
                        <button class="btn-delete" onclick="deleteTestimonial('{{ t.id }}')">
                            <i class="bi bi-trash3"></i> Delete
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state" id="emptyState">
                <i class="bi bi-images"></i>
                <h5>No Testimonials Yet</h5>
                <p>Upload photos of client testimonials, completed projects, or happy customers.</p>
            </div>
            {% endif %}
        </div>

        <!-- Footer -->
        <div class="admin-footer">
            <p>&copy; 2025 ASAP Food Trailer — Admin Panel &middot; <a href="/">View Website</a></p>
        </div>
    </main>

    <script>
        function toggleSidebar() {
            document.getElementById('adminSidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('show');
        }

        // ── File Upload ──
        function handleDrop(e) {
            e.preventDefault();
            e.target.closest('.upload-zone').classList.remove('dragover');
            var files = e.dataTransfer.files;
            handleFiles(files);
        }

        async function handleFiles(files) {
            if (!files.length) return;

            var progressEl = document.getElementById('uploadProgress');
            var progressBar = document.getElementById('progressBar');
            var progressText = document.getElementById('progressText');
            progressEl.style.display = 'block';

            var total = files.length;
            var completed = 0;

            for (var i = 0; i < files.length; i++) {
                progressText.textContent = 'Uploading ' + (i + 1) + ' of ' + total + '...';
                progressBar.style.width = (completed / total * 100) + '%';

                var formData = new FormData();
                formData.append('image', files[i]);

                try {
                    var resp = await fetch('/api/testimonials', {
                        method: 'POST',
                        body: formData
                    });
                    var data = await resp.json();
                    if (data.success) {
                        addCardToGrid(data.testimonial);
                        completed++;
                    } else {
                        alert('Failed to upload: ' + (data.detail || 'Unknown error'));
                    }
                } catch (err) {
                    alert('Upload error: ' + err.message);
                }
            }

            progressBar.style.width = '100%';
            progressText.textContent = 'Done! ' + completed + ' photo(s) uploaded.';
            setTimeout(function () {
                progressEl.style.display = 'none';
                progressBar.style.width = '0%';
            }, 2000);

            // Remove empty state if it exists
            var emptyState = document.getElementById('emptyState');
            if (emptyState) emptyState.remove();

            // Update count
            updateCount();
        }

        function addCardToGrid(t) {
            var grid = document.getElementById('galleryGrid');
            if (!grid) {
                // Create grid if first item
                grid = document.createElement('div');
                grid.className = 'gallery-grid';
                grid.id = 'galleryGrid';
                document.querySelector('.admin-content').appendChild(grid);
            }
            var card = document.createElement('div');
            card.className = 'gallery-card';
            card.id = 'card-' + t.id;
            card.innerHTML = '<img src="' + t.image_url + '" alt="Testimonial" loading="lazy"' +
                ' onerror="this.src=\'/assets/img/trucks/placeholder.jpg\';">' +
                '<div class="card-actions">' +
                '<span class="card-date"><i class="bi bi-calendar3"></i> ' +
                (t.created_at ? t.created_at.substring(0, 10) : 'Today') + '</span>' +
                '<button class="btn-delete" onclick="deleteTestimonial(\'' + t.id + '\')">' +
                '<i class="bi bi-trash3"></i> Delete</button></div>';
            grid.prepend(card);
        }

        async function deleteTestimonial(id) {
            if (!confirm('Are you sure you want to delete this testimonial photo?')) return;

            try {
                var resp = await fetch('/api/testimonials/' + id, { method: 'DELETE' });
                var data = await resp.json();
                if (data.success) {
                    var card = document.getElementById('card-' + id);
                    if (card) {
                        card.style.transition = 'all .3s';
                        card.style.transform = 'scale(0.8)';
                        card.style.opacity = '0';
                        setTimeout(function () { card.remove(); updateCount(); }, 300);
                    }
                } else {
                    alert('Failed to delete: ' + (data.detail || 'Unknown error'));
                }
            } catch (err) {
                alert('Delete error: ' + err.message);
            }
        }

        function updateCount() {
            var cards = document.querySelectorAll('.gallery-card');
            var pill = document.querySelector('.stat-pill');
            if (pill) pill.innerHTML = '<i class="bi bi-image"></i> ' + cards.length + ' photos';
        }
    </script>
</body>

</html>