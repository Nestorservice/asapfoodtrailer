<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testimonials Gallery | ASAP Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/admin.css">
    <style>
        .upload-zone {
            border: 2px dashed #dde1e6;
            border-radius: 16px;
            padding: 40px 24px;
            text-align: center;
            cursor: pointer;
            transition: all .3s;
            background: #fafbfc;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #ff6b00;
            background: #fff8f0;
        }

        .upload-zone i {
            font-size: 2.5rem;
            color: #ff6b00;
            margin-bottom: 12px;
        }

        .upload-zone p {
            color: #888;
            margin: 0;
            font-size: .9rem;
        }

        .upload-zone .btn-upload {
            margin-top: 12px;
            background: linear-gradient(135deg, #ff6b00, #ff8c33);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 10px 28px;
            font-weight: 600;
            cursor: pointer;
            transition: transform .2s;
        }

        .upload-zone .btn-upload:hover {
            transform: translateY(-2px);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .gallery-card {
            position: relative;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            background: #fff;
            transition: transform .3s, box-shadow .3s;
        }

        .gallery-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .gallery-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .gallery-card .card-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
        }

        .gallery-card .card-date {
            font-size: .75rem;
            color: #999;
        }

        .gallery-card .btn-delete {
            background: #fff0f0;
            color: #dc3545;
            border: none;
            border-radius: 8px;
            padding: 6px 14px;
            font-size: .78rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
        }

        .gallery-card .btn-delete:hover {
            background: #dc3545;
            color: #fff;
        }

        .upload-progress {
            display: none;
            margin-top: 16px;
        }

        .upload-progress .progress {
            height: 8px;
            border-radius: 4px;
        }

        .upload-progress .progress-bar {
            background: linear-gradient(90deg, #ff6b00, #ff8c33);
            border-radius: 4px;
            transition: width .3s;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #bbb;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            color: #ddd;
        }

        .empty-state h5 {
            font-weight: 600;
            color: #aaa;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: .85rem;
        }

        .stat-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #f0f4ff;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: .8rem;
            font-weight: 600;
            color: #0d6efd;
        }

        @media (max-width: 767px) {
            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 12px;
            }

            .gallery-card img {
                height: 140px;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="adminSidebar">
        <div class="sidebar-header">
            <img src="/assets/img/logo/logo.jpg" alt="ASAP" class="sidebar-logo" style="height:32px;border-radius:6px;">
            <button class="sidebar-close d-lg-none" onclick="toggleSidebar()"><i class="bi bi-x-lg"></i></button>
        </div>
        <nav class="sidebar-nav">
            <a href="/admin/dashboard" class="nav-item"><i class="bi bi-grid-1x2"></i> Dashboard</a>
            <a href="/admin/inventory" class="nav-item"><i class="bi bi-truck"></i> Inventory</a>
            <a href="/admin/leads" class="nav-item"><i class="bi bi-person-lines-fill"></i> Leads</a>
            <a href="/admin/testimonials" class="nav-item active"><i class="bi bi-images"></i> Testimonials</a>
            <div class="nav-divider"></div>
            <a href="/" class="nav-item"><i class="bi bi-globe"></i> View Website</a>
            <a href="/admin" class="nav-item" style="color:#ff6b6b;"><i class="bi bi-box-arrow-left"></i> Sign Out</a>
        </nav>
    </aside>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Main -->
    <main class="admin-main">
        <div class="admin-topbar">
            <div class="d-flex align-items-center gap-3">
                <button class="topbar-toggle d-lg-none" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
                <h5 class="mb-0" style="font-family:'Outfit',sans-serif;font-weight:800;">Testimonials Gallery</h5>
            </div>
            <div class="topbar-right d-flex align-items-center gap-3">
                <span class="stat-pill"><i class="bi bi-image"></i> {{ testimonials | length }} photos</span>
            </div>
        </div>

        <div class="admin-content">
            <!-- Upload Zone -->
            <div class="admin-card mb-4">
                <div class="admin-card-header">
                    <h6><i class="bi bi-plus-circle"></i> Add New Testimonial</h6>
                </div>
                <div class="admin-card-body">
                    <form id="testimonialForm" onsubmit="submitTestimonial(event)">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="bi bi-person"></i> Client Name</label>
                                <input type="text" class="form-control" name="name" placeholder="e.g. John Smith"
                                    style="border-radius:10px;padding:10px 14px;">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="bi bi-briefcase"></i> Role /
                                    Business</label>
                                <input type="text" class="form-control" name="role" placeholder="e.g. Food Truck Owner"
                                    style="border-radius:10px;padding:10px 14px;">
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold"><i class="bi bi-chat-quote"></i> Testimonial
                                    Text</label>
                                <textarea class="form-control" name="text" rows="3"
                                    placeholder="What did the client say about your service?"
                                    style="border-radius:10px;padding:10px 14px;"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="bi bi-star"></i> Rating</label>
                                <select class="form-select" name="rating" style="border-radius:10px;padding:10px 14px;">
                                    <option value="5">⭐⭐⭐⭐⭐ (5 stars)</option>
                                    <option value="4">⭐⭐⭐⭐ (4 stars)</option>
                                    <option value="3">⭐⭐⭐ (3 stars)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="bi bi-image"></i> Photo (optional)</label>
                                <input type="file" class="form-control" name="image" accept="image/*"
                                    style="border-radius:10px;padding:10px 14px;">
                            </div>
                            <div class="col-12">
                                <div class="upload-progress" id="uploadProgress">
                                    <div class="progress">
                                        <div class="progress-bar" id="progressBar" style="width:0%"></div>
                                    </div>
                                    <small class="text-muted mt-1 d-block" id="progressText">Uploading...</small>
                                </div>
                                <button type="submit" class="btn-upload mt-2" id="submitBtn"
                                    style="width:100%;padding:12px;font-size:1rem;">
                                    <i class="bi bi-plus-lg"></i> Add Testimonial
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Gallery Grid -->
            {% if testimonials %}
            <div class="gallery-grid" id="galleryGrid">
                {% for t in testimonials %}
                <div class="gallery-card" id="card-{{ t.id }}">
                    {% if t.image_url %}
                    <img src="{{ t.image_url }}" alt="Testimonial" loading="lazy"
                        onerror="this.src='/assets/img/trucks/placeholder.jpg';">
                    {% endif %}
                    {% if t.name or t.text %}
                    <div style="padding:12px;">
                        {% if t.name %}<h6 style="margin:0 0 4px;font-weight:700;font-size:.9rem;">{{ t.name }}</h6>{%
                        endif %}
                        {% if t.role %}<small style="color:#888;">{{ t.role }}</small>{% endif %}
                        {% if t.text %}<p style="margin:6px 0 0;font-size:.85rem;color:#555;line-height:1.4;">{{
                            t.text[:120] }}{{ '...' if t.text|length > 120 }}</p>{% endif %}
                        {% if t.rating %}
                        <div style="margin-top:4px;">
                            {% for i in range(t.rating|default(5)) %}<i class="bi bi-star-fill"
                                style="color:#ff6b00;font-size:.7rem;"></i>{% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="card-actions">
                        <span class="card-date"><i class="bi bi-calendar3"></i> {{ t.created_at[:10] if t.created_at
                            else 'Unknown' }}</span>
                        <button class="btn-delete"
                            onclick="confirmDeleteTestimonial('{{ t.id }}', '{{ t.image_url|default('') }}')">
                            <i class="bi bi-trash3"></i> Delete
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state" id="emptyState">
                <i class="bi bi-images"></i>
                <h5>No Testimonials Yet</h5>
                <p>Add client testimonials with photos and quotes to showcase on your website.</p>
            </div>
            {% endif %}
        </div>

        <!-- Footer -->
        <div class="admin-footer">
            <p>&copy; 2025 ASAP Food Trailer — Admin Panel &middot; <a href="/">View Website</a></p>
        </div>
    </main>

    <!-- Delete Confirmation Modal (must be before script) -->
    <div class="modal fade" id="deleteTestimonialModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered" style="max-width:400px;">
            <div class="modal-content" style="border-radius:16px;overflow:hidden;border:none;">
                <div class="modal-header" style="background:#fff0f0;border-bottom:1px solid #ffe0e0;">
                    <h6 class="modal-title" style="font-weight:700;color:#dc3545;"><i
                            class="bi bi-exclamation-triangle"></i> Delete Testimonial</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="deleteTestimonialBody"></div>
                <div class="modal-footer" style="border-top:1px solid #eee;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        style="border-radius:8px;">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteTestimonialBtn"
                        style="border-radius:8px;font-weight:600;">
                        <i class="bi bi-trash3"></i> Yes, Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes slideIn {
            from {
                transform: translateX(100px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .custom-toast {
            transition: all .3s;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function toggleSidebar() {
            document.getElementById('adminSidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('show');
        }

        function showToast(message, type) {
            var existing = document.querySelector('.custom-toast');
            if (existing) existing.remove();
            var colors = { success: '#28a745', error: '#dc3545', warning: '#ff6b00' };
            var icons = { success: 'bi-check-circle', error: 'bi-x-circle', warning: 'bi-exclamation-triangle' };
            var toast = document.createElement('div');
            toast.className = 'custom-toast';
            toast.style.cssText = 'position:fixed;top:24px;right:24px;z-index:10000;padding:14px 24px;border-radius:12px;color:#fff;font-weight:600;font-size:.9rem;display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,0.2);animation:slideIn .3s;background:' + (colors[type] || colors.error);
            toast.innerHTML = '<i class="bi ' + (icons[type] || icons.error) + '"></i> ' + message;
            document.body.appendChild(toast);
            setTimeout(function () { toast.style.opacity = '0'; toast.style.transform = 'translateX(100px)'; setTimeout(function () { toast.remove(); }, 300); }, 3000);
        }

        function handleDrop(e) { e.preventDefault(); }

        async function submitTestimonial(e) {
            e.preventDefault();
            var form = document.getElementById('testimonialForm');
            var btn = document.getElementById('submitBtn');
            var progressEl = document.getElementById('uploadProgress');
            var progressBar = document.getElementById('progressBar');
            var progressText = document.getElementById('progressText');

            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Adding...';
            progressEl.style.display = 'block';
            progressBar.style.width = '50%';
            progressText.textContent = 'Uploading testimonial...';

            var fd = new FormData(form);
            try {
                var resp = await fetch('/api/testimonials', { method: 'POST', body: fd });
                if (resp.ok) {
                    var data = await resp.json();
                    if (data.success) {
                        addCardToGrid(data.testimonial);
                        showToast('Testimonial added!', 'success');
                        form.reset();
                        var emptyState = document.getElementById('emptyState');
                        if (emptyState) emptyState.remove();
                        updateCount();
                    } else {
                        showToast('Failed: ' + (data.detail || 'Unknown error'), 'error');
                    }
                } else {
                    var errData = {}; try { errData = await resp.json(); } catch (ex) { }
                    showToast('Error: ' + (errData.detail || resp.statusText), 'error');
                }
            } catch (err) { showToast('Error: ' + err.message, 'error'); }

            progressBar.style.width = '100%';
            progressText.textContent = 'Done!';
            setTimeout(function () { progressEl.style.display = 'none'; progressBar.style.width = '0%'; }, 1500);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-plus-lg"></i> Add Testimonial';
        }

        function addCardToGrid(t) {
            var grid = document.getElementById('galleryGrid');
            if (!grid) { grid = document.createElement('div'); grid.className = 'gallery-grid'; grid.id = 'galleryGrid'; document.querySelector('.admin-content').appendChild(grid); }
            var card = document.createElement('div'); card.className = 'gallery-card'; card.id = 'card-' + t.id;
            var html = '';
            if (t.image_url) {
                html += '<img src="' + t.image_url + '" alt="Testimonial" loading="lazy" onerror="this.src=\'/assets/img/trucks/placeholder.jpg\';">';
            }
            if (t.name || t.text) {
                html += '<div style="padding:12px;">';
                if (t.name) html += '<h6 style="margin:0 0 4px;font-weight:700;font-size:.9rem;">' + t.name + '</h6>';
                if (t.role) html += '<small style="color:#888;">' + t.role + '</small>';
                if (t.text) html += '<p style="margin:6px 0 0;font-size:.85rem;color:#555;line-height:1.4;">' + (t.text.length > 120 ? t.text.substring(0, 120) + '...' : t.text) + '</p>';
                if (t.rating) {
                    html += '<div style="margin-top:4px;">';
                    for (var s = 0; s < t.rating; s++) html += '<i class="bi bi-star-fill" style="color:#ff6b00;font-size:.7rem;"></i>';
                    html += '</div>';
                }
                html += '</div>';
            }
            html += '<div class="card-actions"><span class="card-date"><i class="bi bi-calendar3"></i> Today</span>' +
                '<button class="btn-delete" onclick="confirmDeleteTestimonial(\'' + t.id + '\', \'' + (t.image_url || '') + '\')"><i class="bi bi-trash3"></i> Delete</button></div>';
            card.innerHTML = html;
            grid.prepend(card);
        }

        // ── Delete with styled modal ──
        var pendingDeleteId = null;
        function confirmDeleteTestimonial(id, imageUrl) {
            pendingDeleteId = id;
            document.getElementById('deleteTestimonialBody').innerHTML =
                '<div style="text-align:center;padding:10px;">' +
                '<img src="' + imageUrl + '" style="width:100%;max-height:200px;object-fit:cover;border-radius:12px;margin-bottom:16px;" onerror="this.src=\'/assets/img/trucks/placeholder.jpg\'">' +
                '<p style="color:#666;margin:0 0 12px;">Are you sure you want to delete this testimonial photo?</p>' +
                '<p style="color:#dc3545;font-weight:600;margin:0;"><i class="bi bi-exclamation-triangle"></i> This action cannot be undone!</p></div>';
            new bootstrap.Modal(document.getElementById('deleteTestimonialModal')).show();
        }

        document.getElementById('confirmDeleteTestimonialBtn').addEventListener('click', async function () {
            if (!pendingDeleteId) return;
            var btn = this; btn.disabled = true; btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...';
            try {
                var resp = await fetch('/api/testimonials/' + pendingDeleteId, { method: 'DELETE' });
                var data = await resp.json();
                if (data.success) {
                    showToast('Testimonial deleted!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('deleteTestimonialModal')).hide();
                    var card = document.getElementById('card-' + pendingDeleteId);
                    if (card) { card.style.transition = 'all .3s'; card.style.transform = 'scale(0.8)'; card.style.opacity = '0'; setTimeout(function () { card.remove(); updateCount(); }, 300); }
                } else { showToast('Delete failed: ' + (data.detail || 'Unknown error'), 'error'); }
            } catch (err) { showToast('Delete error: ' + err.message, 'error'); }
            btn.disabled = false; btn.innerHTML = '<i class="bi bi-trash3"></i> Yes, Delete';
        });

        function updateCount() {
            var cards = document.querySelectorAll('.gallery-card');
            var pill = document.querySelector('.stat-pill');
            if (pill) pill.innerHTML = '<i class="bi bi-image"></i> ' + cards.length + ' photos';
        }
    </script>
</body>

</html>